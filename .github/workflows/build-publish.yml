name: build-publish

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    tags: [ "*" ]
  pull_request:
    branches: [ "main" ]
  
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: 
  contents: read
  packages: write
  
jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    permissions: 
      contents: write
      packages: write
      pages: write
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      with: 
        fetch-depth: '0'
        submodules: 'true'
        token: '${{ secrets.SEMVER_TOKEN }}'
    - name: Configure Git
      run: |
        git config user.name "$GITHUB_ACTOR"
        git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
        git submodule update --init --recursive
    - uses: azure/setup-helm@b9e51907a09c216f16ebe8536097933489208112 #v4.3.0
    - name: Prepare GPG key 
      run: |
        gpg_dir=.cr-gpg
        mkdir "$gpg_dir"
        keyring="$gpg_dir/secring.gpg"
        base64 -d <<< "$GPG_KEYRING_BASE64" > "$keyring" 
        passphrase_file="$gpg_dir/passphrase"
        echo "$GPG_PASSPHRASE" > "$passphrase_file" 
        echo "CR_PASSPHRASE_FILE=$passphrase_file" >> "$GITHUB_ENV" 
        echo "CR_KEYRING=$keyring" >> "$GITHUB_ENV" 
      env:
        GPG_KEYRING_BASE64: "${{ secrets.GPG_KEYRING_BASE64 }}"
        GPG_PASSPHRASE: "${{ secrets.GPG_PASSPHRASE }}"
    - name: Login to GHCR
      uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Update Dependencies
      id: deps
      run: |
        for dir in $(ls -d charts/*/); do
          if [ -f "$dir/Chart.yaml" ] && grep -q '^dependencies:' "$dir/Chart.yaml"; then
            helm dependency list "$dir" | tail -n +2 | awk '$3 !~ /^oci:\/\// { print "helm repo add " $1 " " $3 }' | sort -u | while read -r cmd; do
                $cmd || echo "Repo add failed. Assuming it already exists."
            done
            helm dependency update "$dir"
          fi
        done
    - name: Run chart-releaser
      uses: helm/chart-releaser-action@cae68fefc6b5f367a0275617c9f83181ba54714f #1.7.0
      env:
        CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        CR_KEY: "${{ secrets.CR_KEY }}"
        CR_SIGN: true
      with:
        charts_dir: 'charts'
        skip_existing: 'true'
    - name: Deploy artifacthub-repo.yml to gh-pages
      if: github.ref == 'refs/heads/main'
      run: |
        git config user.name "$GITHUB_ACTOR"
        git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
        git fetch origin gh-pages
        git checkout gh-pages
        git checkout main -- artifacthub-repo.yml
        git add artifacthub-repo.yml
        if git diff --staged --quiet; then
          echo "No changes to artifacthub-repo.yml"
        else
          git commit -m "Update artifacthub-repo.yml from main [skip ci]"
          git push origin gh-pages
        fi
        git checkout main
    - name: Push chart to GHCR
      run: |
        shopt -s nullglob
        for pkg in .cr-release-packages/*.tgz; do
          if [ -z "${pkg:-}" ]; then
            break
          fi
          helm push "${pkg}" oci://ghcr.io/${{ github.repository }}
        done
      env:
          HELM_EXPERIMENTAL_OCI: 1
