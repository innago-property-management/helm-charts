apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "innago-vault-k8s-role-operator.serviceAccountName" . }}
  labels:
    app.kubernetes.io/part-of: {{ .Release.Name }}
rules:
  # ============================================================================
  # RBAC validated via EKS audit logging on 2025-12-16
  # See: kubectl rbac-tool auditgen
  # ============================================================================

  # Read access to ConfigMaps (cluster-scoped for Vault role config discovery)
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]

  # Read access to Deployments (operator queries deployment info at startup)
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "watch"]

  # Create Jobs (operator creates jobs for Vault token rotation)
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["create"]

  # Leader election coordination (required for operator HA)
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["create", "delete", "get", "patch", "update"]

  # Non-resource URLs (health/version checks)
  - nonResourceURLs: ["/version/"]
    verbs: ["get"]
